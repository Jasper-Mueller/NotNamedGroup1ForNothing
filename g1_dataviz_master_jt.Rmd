---
title: "Visualizing World Happiness"
author: "Group 1"
date: "12/3/2020"
output: html_document
---

# Purpose 

The goal of our project is to explore whether popular happiness sayings hold true in reality by exploring the world happiness report as well as datasets on food consumption, gender equality, GDP per capita, social equality and alcohol consumption. The happiness dataset was retrieved from Kaggle and includes data on countries measured in an index called the happiness score.


# Loading and Cleaning the datasets


```{r load libraries}

library(readr)
library(dplyr)
library(vroom)
library(janitor)
library(here)
library(Hmisc)
library(gapminder)
library(countrycode)
library(tidyverse)
library(showtext)
library(rnaturalearth)
library(ggridges)
library(rworldmap)
library(tidyverse)
library(rasterVis)
library(quantreg)
library(corrplot)
library(RColorBrewer)
library(gridExtra)
library(GGally)
library(sf)
library(ggExtra)
library(MASS)
library(viridis)
library(ggrepel)
library(dichromat)
library(rpart)
library(caTools)
library(rpart.plot)
library(extrafont)
```


## Load the data

### Happiness Data

We start off with by loading in the happiness data. The data set was retrieved from Kaggle and includes data on countries measured in an index called the happiness score.
The happiness scores use data from the Gallup World Poll. The scores are based on answers to the main life evaluation question asked in the poll. This question, known as the Cantril Ladder, asks respondents to think of a ladder with the best possible life for them being a 10 and the worst possible life being a 0 and to rate their own current lives on that scale.
The data set also includes data on other socio-economic indicators, which we will ignore for our analysis.

```{r loading data}
#load happiness data 
data_2019 <- vroom::vroom(here::here("00_Data","2019.csv")) %>% 
  clean_names()

```


```{r adding additional information}
#additional information 
data_2019_01 <- data_2019

data_2019_02 <- data_2019_01 %>% 
  mutate(continent = countrycode(sourcevar = data_2019_01[[2]],
                            origin = "country.name",
                            destination = "continent"),
         region = countrycode(sourcevar = data_2019_01[[2]],
                            origin = "country.name",
                            destination = "region"),
         iso2c = countrycode(sourcevar = data_2019_01[[2]],
                            origin = "country.name",
                            destination = "iso2c"),
         )

```


We get an error message, as the country code function could not match and iso2 code to all country names. 

One of the 2 countries without iso code is Kosovo.
We are therefore going to impute those values with the code "XK", as used by the European commission.


```{r}
#impute Kosovo
data_2019_03 <- data_2019_02 %>%
  mutate(iso2c = if_else(country_or_region=="Kosovo", 
                         "XK", 
                         iso2c) ,
         continent = if_else(country_or_region=="Kosovo",
                             "Europe",
                             continent)
  ) 

data_2019_03 %>% 
  group_by(iso2c) %>% 
  count() %>% 
  arrange(desc(n))

data_2019_03 %>% 
  filter(iso2c == "CY")

```

Northern Cyprus and Cyprus are listed as different countries.  
The iso standard however has them listed as one country.  
for our further analysis we will combine the two, taking the average

```{r cyprus, warning = FALSE}

#Aggreagating numeric values
cy_data <- aggregate(x = data_2019_03, by = list(data_2019_03$iso2c), FUN = mean) %>% 
  filter(Group.1 == "CY")

#replacing Cyprus values with averages
data_2019_04 <- data_2019_03 %>% 
  mutate(score = if_else(country_or_region == "Cyprus", cy_data$score, score),
         gdp_per_capita = if_else(country_or_region == "Cyprus", cy_data$gdp_per_capita, gdp_per_capita),
         social_support = if_else(country_or_region == "Cyprus", cy_data$social_support, social_support),
         healthy_life_expectancy = if_else(country_or_region == "Cyprus",cy_data$healthy_life_expectancy, healthy_life_expectancy),
         freedom_to_make_life_choices = if_else(country_or_region == "Cyprus", cy_data$freedom_to_make_life_choices, freedom_to_make_life_choices),
         generosity = if_else(country_or_region == "Cyprus", cy_data$generosity, generosity),
         perceptions_of_corruption = if_else(country_or_region == "Cyprus", cy_data$perceptions_of_corruption, perceptions_of_corruption)
           ) %>% 
  #deleting Northern Cyprus
  filter(country_or_region != "Northern Cyprus")

```

```{r final data set happy}

happy_data_2019 <- data_2019_04

rm(data_2019, data_2019_01, data_2019_02, data_2019_03, data_2019_04, cy_data)

```

### Adding population data

Next we are going to add population data to our data set.
The 2019 data is retrieved from the world bank:
http://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=csv

```{r loading pop data}
country_population <- read_csv("00_Data/country_population.csv", 
    skip = 3) %>% 
  clean_names() %>% dplyr::select(c(country_name, country_code, x2019))

```
We clean the data and add it to our data set.
We add data for Taiwan (TW) and Kosovo (XK) manually, as they are not included in the csv file.
The data for the two countries is taken from worldbank for Kosovo  
(https://data.worldbank.org/indicator/SP.POP.TOTL?end=2019&locations=XK&start=2019&view=bar),
and from worldometer.info for Taiwan  
(https://www.worldometers.info/world-population/taiwan-population/)

```{r adding pop data}
#adding population data 
country_population <- country_population %>% 
  mutate(iso2c = countrycode(sourcevar = country_population[[1]],
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c))

happy_data_2019_02 <- left_join(happy_data_2019, country_population, by = "iso2c")

happy_data_2019_02 <- happy_data_2019_02 %>% 
  mutate(x2019 = case_when(iso2c == "TW" ~ 23773876,
                           iso2c == "XK" ~ 1794248,
                           TRUE ~ x2019)) %>% 
  rename(population = x2019)

#https://data.worldbank.org/indicator/SP.POP.TOTL?locations=XK

happy_data_2019 <- happy_data_2019_02 %>% 
  dplyr::select(-c(country_name, country_code))
  
rm(happy_data_2019_02, country_population)
```


## Adding GDP Data 

In order to examine impact of wealth on happiness, we will use the Gapminder 2019 dataset. 



```{r loading wealth data}

#Loading data on gini index, the gap minder data set, employment and gni data


gapminder_2019 <- vroom::vroom(here::here("00_Data","gapminder 2019.csv")) %>% 
  clean_names() %>% 
  rename(gdpPercap = x2019)


gini_2019 <- vroom::vroom(here::here("00_Data","gini.csv")) %>% 
  clean_names() %>% 
  rename(gini = x2019)


grossni_2019<- read.csv("00_Data/gni2019.csv") %>% 
  clean_names() %>% 
  rename(grossni = x2019) 


emp_2019<- read.csv("00_Data/employment.csv") %>% 
  clean_names() %>% 
  rename(emp_rate = x2019) 

```

We clean the data and adding it to our data set. 

```{r}

#adding gapminder

gapminder_2019 <- gapminder_2019 %>% 
  mutate(iso2c = countrycode(sourcevar = country,
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c))

gapminder_2019_merged <- merge(happy_data_2019, gapminder_2019, ) %>% 
  dplyr::select(-country)

#adding gini

gini_2019 <- gini_2019 %>% 
  mutate(iso2c = countrycode(sourcevar = country,
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c)) %>% 
  dplyr::select(-c(x2018, country))

gapminder_2019_merged <- merge(gapminder_2019_merged, gini_2019)

#adding grossni

grossni_2019 <- grossni_2019 %>% 
  mutate(iso2c = countrycode(sourcevar = grossni_2019[[1]],
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c)) %>% 
  dplyr::select(-c(country))

gapminder_2019_merged <- merge(gapminder_2019_merged, grossni_2019)

#adding employment

emp_2019 <- emp_2019 %>% 
  mutate(iso2c = countrycode(sourcevar = emp_2019[[1]],
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c)) %>% 
  dplyr::select(-c(country))

happy_data_2019 <- merge(gapminder_2019_merged, emp_2019)


rm(gini_2019, gapminder_2019, gapminder_2019_merged)

```

Next, we impute missing values using IMF data for the 4 economic variables added above

```{r}

# adding data from IMF
# IMF: World Economic Outlook (WEO) Database, October 2020  Verified
# Link:https://knoema.com/IMFWEO2020Oct/imf-world-economic-outlook-weo-database-october-2020
data <- happy_data_2019 %>% 
  dplyr::mutate(
    gdpPercap = if_else(country_or_region == "Bhutan", as.numeric(11968), gdpPercap),
    gdpPercap = if_else(country_or_region == "Eritrea", as.numeric(1836), gdpPercap),
    gdpPercap = if_else(country_or_region == "Iran", as.numeric(12547), gdpPercap),
    gdpPercap = if_else(country_or_region == "Marshall Islands", as.numeric(3932), gdpPercap),
    gdpPercap = if_else(country_or_region == "Palau", as.numeric(15916), gdpPercap),
    # take 2018 value since no 2019....
    gdpPercap = if_else(country_or_region == "Palestine", as.numeric(5795), gdpPercap), 
    gdpPercap = if_else(country_or_region == "San Marino", as.numeric(63133), gdpPercap),
    gdpPercap = if_else(country_or_region == "South Sudan", as.numeric(862), gdpPercap),
    gdpPercap = if_else(country_or_region == "Tonga", as.numeric(6138), gdpPercap),
    gdpPercap = if_else(country_or_region == "Turkmenistan", as.numeric(16711), gdpPercap),
    gdpPercap = if_else(country_or_region == "Venezuela", as.numeric(7344), gdpPercap),
    gdpPercap = if_else(country_or_region == "Yemen", as.numeric(2057), gdpPercap),
    gdpPercap = if_else(country_or_region == "Papua New Guinea", as.numeric(4018), gdpPercap),
    gdpPercap = if_else(country_or_region == "Sudan", as.numeric(4140), gdpPercap),
    gdpPercap = if_else(country_or_region == "Angola", as.numeric(7384), gdpPercap),
    gdpPercap = if_else(country_or_region == "Solomon Islands", as.numeric(2590), gdpPercap),
    gdpPercap = if_else(country_or_region == "Guyana", as.numeric(13604), gdpPercap),
    gdpPercap = if_else(country_or_region == "Bahamas", as.numeric(39557), gdpPercap),
    gdpPercap = if_else(country_or_region == "Oman", as.numeric(33749), gdpPercap),
    gdpPercap = if_else(country_or_region == "Suriname", as.numeric(16768), gdpPercap),
    gdpPercap = if_else(country_or_region == "Fiji", as.numeric(14026), gdpPercap),
    gdpPercap = if_else(country_or_region == "Guinea-Bissau", as.numeric(2429), gdpPercap)
                                 )
data <- data %>% 
  dplyr::mutate(
    gdpPercap = if_else(iso2c == "AQ", as.numeric(1), gdpPercap),
    gdpPercap = if_else(iso2c == "GL", as.numeric(41800), gdpPercap),
    gdpPercap = if_else(iso2c == "CU", as.numeric(21016), gdpPercap),
    gdpPercap = if_else(iso2c == "KP", as.numeric(1700), gdpPercap),
    gdpPercap = if_else(iso2c == "SO" , as.numeric(900), gdpPercap),
    gdpPercap = if_else(iso2c == "SY" , as.numeric(2900), gdpPercap)
    )

happy_data_2019 <- data

rm(data, emp_2019, grossni_2019)

```



### Food

In order to explore the relationship between happiness and food, we will use data from the Food and Agriculture Organization of the United Nations. 

First, we load the data. 

```{r}

food_supply <- vroom::vroom(here::here("00_Data","foodbalance.csv")) %>% 
  clean_names()

#deselecting rows
food_supply <- food_supply %>%
  dplyr::select(-c(domain_code, domain, area_code, element_code, item_code, year_code, flag, flag_description, unit))


```


Next we clean the data and create food categories. 

```{r}
food_supply_tidy <- food_supply %>%
  pivot_wider(names_from="element", values_from="value") %>%
  mutate(category=case_when(item %in% c("Wheat and products", "Rice and products", "Barley and Products", "Maize and products", "Rye and products", "Oats", "Millet and products", "Sorghum and products", "Cereals, Other") ~ "Grains", item %in% c( "Potatoes and Products", "Sweet potatoes", "Yams", "Roots, Other") ~ "Starches", 
                            item %in% c("Sugar cane", "Sugar beet", "Sugar non-centrifugal", "Sugar (Raw Equivalent)", "Sweeteners, Other", "Honey")~"Sugar and Sweeteners", 
                            item %in% c("Beans", "Peas", "Pulses, Other and Products")~"Legumes", 
                            item %in% c("Nuts and products", "Soyabeans", "Groundnuts (Shelled Eq)", "Sunflower seed", "Rape and Mustardseed", "Cottonseed", "Sesame seed", "Coconuts - Incl Copra", "Palm kernels")~ "Nuts and seeds", 
         item %in% c("Oilcrops, Other", "Soyabean Oil", "Groundnut Oil", "Sunflowerseed Oil", "Rape and Mustard Oil", "Cottonseed Oil", "Palmkernel Oil", "Coconut Oil", "Sesameseed Oil", "Olive Oil", "Ricebran Oil", "Maize Germ Oil", "Oilcrops Oil, Other")~"Oils", 
         item %in% c("Olives (including preserved)", "Tomatoes and products", "Onions","Vegetables, Other", "Oranges, Mandarines", "Lemons, Limes, and products","Grapefruit and products", "Citrus, Other", "Bananas", "Plantains", "Apples and products", "Pineapples and products", "Dates", "Grapes and products (excl wine)", "Fruits, Other")~"Fruits and Vegetables", 
         item %in% c("Coffee and products", "Tea (including mate)")~"Coffee and Tea", 
         item %in% c("Cocoa Beans and products")~"Chocolate", 
         item %in% c("Pepper", "Pimento", "Cloves", "Spices, Other")~ "Spices", 
         item %in% c("Wine", "Beer", "Beverages, Fermented", "Beverages, Alcoholic", "Alcohol, Non-Food")~"Alcohol", item %in% c("Bovine meat", "Mutton & Goat Meat", "Pigmeat", "Poultry Meat", "Meat, Other", "Offals, Edible", "Meat, Aquatic Mammals")~ "Meat", 
         item %in% c("Butter, Ghee", "Cream", "Fats, Animals, Raw", "Eggs", "Milk")~"Eggs and Dairy", 
         item %in% c("Fish, Body Oil", "Fish, Liver Oil", "Freshwater Fish", "Demersal Fish", "Pelagic Fish", "Marine Fish, Other", "Crustaceans", "Cephalopods", "Molluscs, Other", "Aquatic Animals, Others", "Aquatic Plants")~ "Seafood", 
         item %in% c("Population", "Infant food", "Miscellaneous")~ "Other"))

#filter out just food categories 
food_supply_tidy <- food_supply_tidy %>%
  filter(category%in%c("Grains", "Meat", "Seafood", "Spices", "Fruits and Vegetables", "Oils", "Nuts and seeds", "Legumes", "Sugar and Sweeteners", "Starches", "Eggs and Dairy", "Chocolate"))%>%
  dplyr::select(-c("Total Population - Both sexes"))


#create iso2c column to match countries 
food_supply_tidy <- food_supply_tidy %>%
  mutate(iso2c = countrycode(sourcevar = food_supply_tidy[[1]],
                            origin = "country.name",
                            destination = "iso2c")) %>% 
  clean_names()%>%
  group_by(iso2c) %>%
  mutate(food_supply_kcal_capita_day = ifelse(is.na(food_supply_kcal_capita_day), 0, food_supply_kcal_capita_day))%>%
  summarise(food_supply_kcal_capita_day=sum(food_supply_kcal_capita_day)) 
  

```

Next we join the food dataset to the world happiness dataset. 

```{r}

#join two dataframes 
happy_data_2019 <- left_join(happy_data_2019, food_supply_tidy , on="iso2c")

rm( food_supply_tidy)
```

### Alcohol

To explore the relationship with alcohol consumption and happiness, we will use data from FiveThirtyEight. 

First, we load the data. 

```{r}
#load alcohol data 
alcohol_2019 <- vroom::vroom(here::here("00_Data","data_new.csv")) %>% 
  clean_names()

```

```{r}
#add iso2 code 
alcohol_2019 <- alcohol_2019 %>% 
  mutate(iso2c = countrycode(sourcevar = country,
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c)) %>% 
  dplyr::select(-c(score))
  
#join to main dataset 
happy_data_2019 <- left_join(happy_data_2019, alcohol_2019 , by=c("iso2c" = "iso2c"))

rm(alcohol_2019)

```


### Gender Equality

In order to examine the relationship between gender equality and happiness, we will look at data from ________


First, we load the data. 
```{r}
#load gender data 
gender_2019 <- vroom::vroom(here::here("00_Data","Gender.csv")) %>% 
  clean_names()

```



```{r}

gender_2019 <- gender_2019 %>% 
  filter(indicator == "Gender equality")

```
cleaning data and adding it to the data set

```{r}
#create iso2c codes
gender_2019 <- gender_2019 %>% 
  dplyr::select(c(country_name, indicator_in_2018)) %>% 
  rename(gender_equ_indicator = indicator_in_2018) %>% 
    mutate(iso2c = countrycode(sourcevar = country_name,
       origin = "country.name",
       destination = "iso2c")) %>% 
  filter(!is.na(iso2c))
  
#merge with main dataset 
happy_data_2019 <- left_join(happy_data_2019, gender_2019 , by=c("iso2c" = "iso2c"))

#remove columns we won't use in analysis 
happy_data_2019 <- happy_data_2019%>%
  dplyr::select(-c(social_support, healthy_life_expectancy, freedom_to_make_life_choices, generosity, perceptions_of_corruption))

```


```{r}
#final dataset 
glimpse(happy_data_2019)
```

```{r}

#load Lato font for plots 
font_add(family = "Lato", regular = "Lato-Black.ttf")
showtext_auto()
```


# Exploring World Happiness Data 

## Map 

Now that we have loaded and cleaned our happiness data, we want to explore it.
We are going to map country happiness score on a world map.
Dark blue means rather happy, lighter colors indicate unhappy.
Countries colored in gray do not have data on happiness in our data set.
For visabilty reasons, we excluded Antarctica from our map.

```{r}


#load world geometries using natural earth package 
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(name != "Antarctica") %>%
  dplyr::select(c(geometry, iso_a2))
#join on iso2c codes to main datasets 
happy_world <- left_join(world, happy_data_2019, by=c("iso_a2" = "iso2c")) %>%
  clean_names()

#plot map vs. happiness score 
ggplot(happy_world)+
  geom_sf(aes(fill=score),     
          show.legend = TRUE, color="white", size=0.2)+    # no legend
  scale_fill_gradient(low = "#DFF5FD", high = "#31489F", na.value = "#DCDCDC")+
  coord_sf(datum = NA) +
  theme_minimal()+
  labs(title="How happy are we?", subtitle= "Happiness score by country", fill= "Happiness Score", caption = "Source: World Happiness Report 2019")  + 
    theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.text.y = element_text(size=9),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title = element_text (size=9), 
        legend.position = "bottom")
  

```

We can see big differences between countries and regions.
While dark colors dominate Oceania, Northern America and Northern Europe, Africa is depicted in lighter colors.
Lets investigate further.

## Ridge Plot 

To have a closer look at how happy certain world regions are, we are going to compare continents.
We will compare 5 different histograms, one for each continent to spot eventual differences between them.

```{r}

#group by continent 
happy_data_2019_labels <- happy_data_2019 %>% 
  group_by(continent) %>% 
  summarise(countries = n()) %>% 
  arrange(countries)

continents_ord <-c("Oceania", "Americas","Europe","Asia","Africa")

ridge_labels <- c("Oceania\n(n=2)","Americas\n(n=23)","Europe\n(n=40)","Asia\n(n=45)","Africa\n(n=45)")


#mapping distributions across continents. 

ggplot(happy_data_2019, aes(x = score, y = factor(continent, levels = continents_ord), 
                            fill = continent, height = (stat(count)))
       ) +
    geom_density_ridges(alpha=0.6, stat="binline", bins=20, scale = 0.95) +
    theme_ridges() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("Happiness Score") +
    ylab("") +
  labs(title="Africa is the most unhappy continent", subtitle="Distribution of happiness across continents", caption = "Source: World Happiness Report 2019") +
  scale_y_discrete(labels= ridge_labels)+
  scale_fill_manual(values = c("#4E67C8", "#B4DCFA", "#FDB519", "#5DCEAF", "#F14124"))+ 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.text.y = element_text(size=9),
        axis.title = element_text(size=9, vjust = -1),
        legend.position = "none")
  
  #geom_label(data = happy_data_2019_labels, aes(label = countries, y = continent)) +
  NULL
```

The ridge plot confirms our assumptions from before.
Oceania and Europe and large parts of the Americas seem fairly happy.
Africa however seems to be the continent with the lowest happiness scores.

## Top and Bottom 

We can already see that happiness varies heavily across regions.
So where are people the happiest? Where are they the unhappiest?
In order to find out we plot the 5 happiest and the 5 unhappiest countries in the world and see how far apart they are.

```{r}
happy_data_2019 %>% 
  mutate(score_norm = score - mean(score)) %>% 
  filter( min_rank(desc(score_norm)) <= 5 | 
                min_rank(score_norm) <= 5 ) %>% 
  mutate(top_bottom = if_else(score_norm>=0, "top", "bottom"),
         top_label = as.numeric(ifelse(top_bottom == "top", score_norm, "")),
         bottom_label = as.numeric(ifelse(top_bottom == "bottom", score_norm, ""))) %>% 
  add_row(score_norm = 0, country_or_region = "") %>% 
  
  
  ggplot(aes(x = score_norm, y = reorder(country_or_region,score_norm))) +
  geom_col(aes(fill = top_bottom)) +
  theme_minimal() +
  labs(y = "", title= "The top countries in terms of happiness are all \nin Northern Europe", subtitle="Difference of the top five happiness scores and bottom five happiness scores \ncompared to the average", x = "Average score = 5.45") +
  theme(legend.position = "none") +
  scale_fill_manual(values=c("#B4DCFA", "#FDB519"))+ 
  geom_text(aes(label=round(top_label,1), fontface=2), hjust=1.5, size=3) +
  geom_text(aes(label=round(bottom_label,1), fontface=2),hjust=-0.8, size=3) +
  geom_vline(xintercept = 0, color="gray") + 
theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=9),
        axis.title.x.bottom = element_text(size=9, vjust = -1, family= "Lato"), 
        legend.title = element_text (size=9))


```

The happy Finns! 
Finnland seems to take the price.
Interestingly enough, the top 5 is completely made up of European countries.
The bottom 5 unhappiest countries are mostly from Africa with the exception of Afghanistan, an Asia country.


# Does money buy happiness? 

To investigate the claim, we sought to explore the relationship between economic indicators and happiness. We looked at the Gapminder dataset and picked 4 variables of interest that best represents a person’s economic wellbeing (GDP per capita PPP, Gini coefficient, GNI per capita & Employment Rate). The thinking here is that a high incomer, equal society with ample jobs would represent a more prosperous society.

We produce 3 plots, a correlation plot, a map and a scatter plot. The first correlation plot was between happiness score and all 4 of the aforementioned economic indicators. This analysis was to identify which indicators are most significantly correlated with happiness – we found this to be GDP per capita and Gini coefficient. The second map plot was to examine the spread of wealth across the globe. The third scatter plot was to examine the effect GDP per capita had in different societies(equal, unequal and moderate). Our analysis interesting found that more money is correlated with higher level of happiness in all countries.


## Faceted by Gini Index 

```{r combined plot}
# Break up into 3 groups according to wealth equality
happy_data_2019_gap <- happy_data_2019 %>%
mutate(
    gini_category = case_when(
      gini <= 33 ~ "Equal socities \n(Gini < 0.33)",
      gini <= 40 ~ "Moderate socities \n(Gini = 0.33-0.40)",
      gini > 40 ~ "Unequal socities \n(Gini > 0.40)"))
# Plot
ggplot(happy_data_2019_gap, aes(y=score, x=log(gdpPercap), color=gini_category))+
  geom_point(alpha=0.5) +
  geom_point(data = happy_data_2019_gap %>% filter(country_or_region == "Switzerland"),
             aes(y=score, x=log(gdpPercap)), color = "red", size = 4, shape = 21, stroke = 1) +
  labs(title="Does money buy happiness?", subtitle = "Relationship of GDP per capita (PPP) and Happiness Score in different societal structures", x="GDP per capita, PPP (log $)", y="Happiness Score", caption ="Source: Gapminder & WHR 2019", color="Gini Coefficient")   +
  theme_minimal() +
  facet_wrap(~gini_category) +
  geom_smooth(method="lm")+
  scale_color_manual(values = c("#FDB519", "#4E67C8", "#5DCEAF"))+
  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"),
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1),
        legend.position = "none") +
  geom_curve(
    data = data.frame(x = 8.5, y = 7.1, xend = 11.3*0.96, yend = 7.48, gini_category = "Equal socities \n(Gini < 0.33)"),
    mapping = aes(x = x, y = y, xend = xend, yend = yend),
    colour = "grey15",
    size = 0.5,
    curvature = -0.25,
    arrow = arrow(length = unit(2, "mm"), type = "closed"),
    inherit.aes = FALSE ) +
  # adding text field
  geom_text(
    data = data.frame(x = 9.1, y = 7, label = "Switzerland", gini_category = "Equal socities \n(Gini < 0.33)"),
    aes(x = x-1, y = y, label = label),
    #colour="#FDB519",
    family="Lato",
    #hjust = 1,
    vjust = 1,
    lineheight = .8,
    inherit.aes = FALSE,
    size=3
  ) +  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"),
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1),
        #legend.position = "none"
        ) +
  NULL

```

## Correlation Matrix 

```{r combined plot, warning=FALSE}


#Select library
happy_data_corr<- happy_data_2019%>%
  dplyr::select(score, gdpPercap, gini, grossni, emp_rate, continent) 

#GGpair
ggpairs(happy_data_corr, columns = 1:5, ggplot2::aes(fill=continent, alpha=0.6), alpha=0.4) + theme_minimal()+ 
labs(title="Economic factors are an important foundation to happiness", subtitle = "Correlation between various economic indicators and happiness", caption ="Source: Gapminder & WHR 2019", color="Continent") +
    scale_fill_manual(values = c("#4E67C8", "#B4DCFA", "#FDB519", "#5DCEAF", "#F14124"))+ 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title = element_text(size=9, face="bold"), 
        legend.position="bottom")
  


```

## Map 

```{r plotting wealth map}

data <- happy_data_2019

# Create world map object
world<-map_data("world")

# Store country names
colnames(world)[5] <- "Country"

# Get ISO2C code
world <- world %>% 
mutate(iso2c = countrycode(sourcevar = world[[5]],
                          origin = "country.name",
                          destination = "iso2c"),
       ) %>%
  filter(Country != "Antarctica")


# Join gapminder to world
data <- left_join(world, happy_data_2019, by = c("iso2c" = "iso2c")) # ISO-code...

# Plot gdpPercap
ggplot()  +
  geom_polygon(data=data, aes(x = long, y = lat, group = group,fill= gdpPercap)) + 
  coord_equal() +scale_fill_gradientn(breaks=c(3,5,7,9), colours=rainbow(8)) +
  labs(title="Where are the riches?", subtitle="Distribution of GDP per capita across the globe") +
  xlab("") + ylab("") + guides(shape=FALSE) + labs(fill="GDP Per Capita")+
scale_fill_gradient(low = "#FCD9D3", high = "#F14124", na.value = "#DCDCDC") +
   theme_minimal() + 
  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(), 
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title = element_text (size=9), 
        legend.position = "bottom", 
        legend.text = element_text(size = 6, color="black"))
```

We found that money is a significant contributor to happiness.  Some critiques on our analysis are:
1)    GDP per capita PPP is an average measure and thus does not reflect the overall wellbeing of a country. Sometimes, a country can have a lot of paper wealth but that does not necessarily into disposable income.
2)    It was difficult to find income data on certain countries such as Greenland, Syria South Sudan etc. Since we used best estimates, there could some bias in our estimates as a result.

# Exploring the relationship between happiness and food consumption 

In order to explore how food impacts happiness, we are using the measure of kcal per capita per person per day. The data comes from the Food and Agriculture Organization of the United nations and is from 2017. 

In this section, we set out to answer two key questions: 


  1. Do countries who have more food tend to score higher on the happiness index? 
  
  2. Do certain types of food impact happiness more than others? 

First, we explore the scatterplot of food versus happiness, by continent. 

## Food scatterplot 

```{r}
#food vs. happiness
happy_data_2019 %>%
  #filter(iso2c != "CN")%>%
  filter(continent!="NA") %>% #remove outlier China cause otherwise it messes with the scale 
  ggplot(aes(x=food_supply_kcal_capita_day, y=score))+
  geom_point(shape=21, alpha=0.5, aes(fill=continent)) +
  geom_point(data = happy_data_2019 %>% filter(country_or_region == "Colombia"),
             aes(x=food_supply_kcal_capita_day, y=score), color = "red",shape = 21, stroke = 1, size = 3) +
  geom_smooth(method="lm", color = "black", size = 0.5, alpha=0.2) + 
  theme_minimal()+ 
  labs(title="Food makes people happy", subtitle="Relationship between food supply (kcal/capita/day) and happiness score", x="Food Supply (kcal/capita/day)", y="Happiness Score", fill="Continent", caption = "World Happiness Report 2019, Food and Agriculture Organization of the United Nations")+ 
  scale_fill_manual(values = c("#4E67C8", "#B4DCFA", "#FDB519", "#5DCEAF", "#F14124"))+ 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title = element_text(size=9, face="bold"), 
        legend.position="bottom") +
  geom_curve(
    data = data.frame(x = 1500, y = 8, xend = 2385*0.97, yend = 6.125*1.02),
    mapping = aes(x = x, y = y, xend = xend, yend = yend),
    colour = "grey15",
    size = 0.5,
    curvature = 0.25,
    arrow = arrow(length = unit(2, "mm"), type = "closed"),
    inherit.aes = FALSE ) +
  # adding text field
  geom_text(
    data = data.frame(x = 1500, y = 8, label = "Colombia"),
    aes(x = x, y = y, label = label),
    #colour="#FDB519",
    family="Lato",
    hjust = 0.5,
    vjust = -1,
    lineheight = .8,
    inherit.aes = FALSE,
    size=3
  ) +  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1),
        legend.position = "bottom"
        )
```
As we can see in the plot above, food supply is positively correlated with happiness, affirming our hypothesis. We will investigate further when we build our model whether food supply is a significant predictor of happiness. 

## Fish consumption 

Next, we will explore how specific foods impact happiness. Omega 3 fatty acids, in some studies, have been found to be correlated with reduced anxiety and depression. We will take a look at whether the top fish consuming countries seem to be happier. 


```{r}
food_supply_tidy <- food_supply %>%
  pivot_wider(names_from="element", values_from="value") %>%
  mutate(category=case_when(item %in% c("Wheat and products", "Rice and products", "Barley and Products", "Maize and products", "Rye and products", "Oats", "Millet and products", "Sorghum and products", "Cereals, Other") ~ "Grains", item %in% c( "Potatoes and Products", "Sweet potatoes", "Yams", "Roots, Other") ~ "Starches", 
                            item %in% c("Sugar cane", "Sugar beet", "Sugar non-centrifugal", "Sugar (Raw Equivalent)", "Sweeteners, Other", "Honey")~"Sugar and Sweeteners", 
                            item %in% c("Beans", "Peas", "Pulses, Other and Products")~"Legumes", 
                            item %in% c("Nuts and products", "Soyabeans", "Groundnuts (Shelled Eq)", "Sunflower seed", "Rape and Mustardseed", "Cottonseed", "Sesame seed", "Coconuts - Incl Copra", "Palm kernels")~ "Nuts and seeds", 
         item %in% c("Oilcrops, Other", "Soyabean Oil", "Groundnut Oil", "Sunflowerseed Oil", "Rape and Mustard Oil", "Cottonseed Oil", "Palmkernel Oil", "Coconut Oil", "Sesameseed Oil", "Olive Oil", "Ricebran Oil", "Maize Germ Oil", "Oilcrops Oil, Other")~"Oils", 
         item %in% c("Olives (including preserved)", "Tomatoes and products", "Onions","Vegetables, Other", "Oranges, Mandarines", "Lemons, Limes, and products","Grapefruit and products", "Citrus, Other", "Bananas", "Plantains", "Apples and products", "Pineapples and products", "Dates", "Grapes and products (excl wine)", "Fruits, Other")~"Fruits and Vegetables", 
         item %in% c("Coffee and products", "Tea (including mate)")~"Coffee and Tea", 
         item %in% c("Cocoa Beans and products")~"Chocolate", 
         item %in% c("Pepper", "Pimento", "Cloves", "Spices, Other")~ "Spices", 
         item %in% c("Wine", "Beer", "Beverages, Fermented", "Beverages, Alcoholic", "Alcohol, Non-Food")~"Alcohol", item %in% c("Bovine meat", "Mutton & Goat Meat", "Pigmeat", "Poultry Meat", "Meat, Other", "Offals, Edible", "Meat, Aquatic Mammals")~ "Meat", 
         item %in% c("Butter, Ghee", "Cream", "Fats, Animals, Raw", "Eggs", "Milk")~"Eggs and Dairy", 
         item %in% c("Fish, Body Oil", "Fish, Liver Oil", "Freshwater Fish", "Demersal Fish", "Pelagic Fish", "Marine Fish, Other", "Crustaceans", "Cephalopods", "Molluscs, Other", "Aquatic Animals, Others", "Aquatic Plants")~ "Seafood", 
         item %in% c("Population", "Infant food", "Miscellaneous")~ "Other"))
```



```{r}
#filter out just food categories 
food_supply_tidy <- food_supply_tidy %>%
  filter(category%in%c("Grains", "Meat", "Seafood", "Spices", "Fruits and Vegetables", "Oils", "Nuts and seeds", "Legumes", "Sugar and Sweeteners", "Starches", "Eggs and Dairy", "Chocolate"))%>%
  dplyr::select(-c("Total Population - Both sexes"))

```


```{r}
#merge with happiness dataframe

#create iso2c column to match countries 
food_supply_tidy <- food_supply_tidy %>%
  mutate(iso2c = countrycode(sourcevar = food_supply_tidy[[1]],
                            origin = "country.name",
                            destination = "iso2c"))


#join two dataframes 
happy_food <- left_join(food_supply_tidy, happy_data_2019, on="iso2c")
```



```{r}
happy_food %>%
 clean_names()%>%
  filter(score!="NA")%>%
  summarise(average = mean(score))

#average happiness score = 5.45 


happy_food_sea <- happy_food %>%
  clean_names() %>%
  group_by(iso2c, continent, score, category, country_or_region) %>%
  mutate(food_supply_kcal_capita_day = ifelse(is.na(food_supply_kcal_capita_day), 0, food_supply_kcal_capita_day))%>%
  summarise(food_supply_kcal_capita_day=sum(food_supply_kcal_capita_day)) %>%
  filter(category=="Seafood", score!= "NA", food_supply_kcal_capita_day>=98) %>%
  arrange(desc(food_supply_kcal_capita_day))

#plotting top 10 fish consuming countries 

plot_labels <- c( "China\n(1)","Iceland\n(2)","Denmark\n(3)","South Korea\n(4)", "Japan\n(5)", "Myanmar\n(6)", "Congo\n(7)", "Norway\n(8)", "Malaysia\n(9)", "Portugal\n(10)")

happy_food_sea %>%
  mutate(above_avg = case_when(score >= 5.45 ~ TRUE, score < 5.45 ~ FALSE))%>%
  ggplot(aes(x=reorder(country_or_region,-food_supply_kcal_capita_day), y=score)) + 
  geom_col(aes(fill=above_avg))+ 
  geom_hline(yintercept=5.45, linetype="dashed", color = "#B4DCFA") + 
  annotate("text", x = 6.5, y=5.9, label = "Average global \nhappiness score = 5.45", size=2.5, family="Lato")+ 
  theme_minimal() + 
  scale_fill_manual(values = c( 'gray', '#4E67C8'))+ 
  scale_x_discrete(labels= plot_labels)+ 
  labs(title="Six of the top ten seafood consuming countries have a \nhappiness score above average", x= "Top 10 seafood consuming countries (kcal/capita/day)", y= "Happiness score", caption = "World Happiness Report 2019, Food and Agriculture Organization of the United Nations")+ 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=6),
        axis.title = element_text(size=9, vjust = -1),
        legend.position = "none", strip.text.x = element_text(size = 8))
  


```

Based on the plot above, six out of the top 10 fish consuming countries are also above average in terms of happiness score. Additionally, Iceland, Denmark, and Norway are all in the top 10 in happiness overall. However, we cannot conclude a causal relationship from this plot. 

One key limitation of the food supply analysis is the metric itself. Unfortunately, we could not find a good, current indicator for food consumption, so we had to settle for food supply. However, this means that countries that export a lot of food would score higher in terms of food supply per capita, even if their population is not actually consuming that much food. Another limitation is that there are probably confounding factors that influence food supply in a specific country. For instance, most countries that have a larger food supply also tend to be wealthier. 

# Alcohol 


We want to explore how happiness and alcohol consumption are related by creating a scatterplot with alcohol consumption on x axis and happiness score on y axis. Since happiness and gdp per capita are correlated it could be that richer countries buy more alcohol. We investigate this by using points of different size to indicate GDP Per Capita. Finally we use the colour to show which type of alcohol is the most consumed in each country. Furthermore, boxplot helps us explore the median value of a happiness score based on the most consumed type of alcohol.


```{r}
#bubble plot 
happy_data_alc<-happy_data_2019 %>% 
  group_by(country) %>% 
  mutate(most_loved=if_else(beer_servings>wine_servings & beer_servings>spirit_servings,'Beer',
                            if_else(wine_servings>beer_servings & wine_servings>spirit_servings,'Wine','Spirits')))
data <- happy_data_alc %>% 
  mutate(most_loved=if_else(beer_servings==0 & wine_servings==0 & spirit_servings==0,'None',most_loved)) %>% 
  filter(!is.na(total_litres_of_pure_alcohol))
ggplot(data,aes(x=total_litres_of_pure_alcohol,y=score,size=gdpPercap, color=most_loved))+
  geom_point(alpha=0.5)+
  geom_point(data = data %>% filter(country_or_region == "Germany"),
             aes(x=total_litres_of_pure_alcohol,y=score, size=gdpPercap), color = "red",shape = 21, stroke = 2)+
  theme_minimal()+
  labs(title='In happier countries people drink more, but they are also richer!',subtitle='Beer is the most consumed drink overall',x='Litres of alcohol per person',y='Happiness Score',caption='Source: WHR & FivethirtyEight')+
   theme_minimal() + 
  scale_color_manual(values=c("#FF8021", "#5ECCF3", "#31489F", "#5DCEAF")) + 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray", hjust=1),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title= element_text(face="bold", size=8))+ 
  labs(size="GDP Per Capita",color='Most Consumed') +
  guides(size = guide_legend(override.aes = list(color = "grey", stroke = 0) ),
         color = guide_legend(override.aes = list(size = 4))
         ) +
    geom_curve(
    data = data.frame(x = 12.5, y = 4.2, xend = 11.3*1.02, yend = 6.985*0.97),
    mapping = aes(x = x, y = y, xend = xend, yend = yend),
    colour = "grey15",
    size = 0.5,
    curvature = 0.25,
    arrow = arrow(length = unit(2, "mm"), type = "closed"),
    inherit.aes = FALSE ) +
  # adding text field
  geom_text(
    data = data.frame(x = 12.5, y = 4.2, label = "Germany"),
    aes(x = x, y = y, label = label),
    #colour="#FDB519",
    family="Lato",
    #hjust = 1,
    vjust = 1,
    lineheight = .8,
    inherit.aes = FALSE,
  ) +  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1),
        #legend.position = "none"
        ) +
  NULL
```

```{r}
#boxplot
data2<- data %>% 
  filter(most_loved %in% c('Beer','Wine','Spirits')) %>% 
  group_by(most_loved)


ggplot(data2,aes(x=reorder(most_loved,-score),y=score))+
  geom_boxplot(alpha=0.6, aes(fill=most_loved))+
  theme_minimal()+
  labs(title='Countries that consume wine the most are the happiest', subtitle='Box and whisker plot of countries that consume mostly wine, beer, or spirits.',x='Most Consumed',y='Score',caption='Source: WHR & FivethirtyEight')+
   theme_minimal() + 
  scale_fill_manual(values=c("#FF8021", "#31489F", "#5DCEAF"))+ 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray", hjust=1),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1), 
        legend.position="none")
```
Due to data availability the alcohol consumption dataset is from 2010, while happiness report is from 2019. We believe this is a good approximation, but are aware having more recent data for alcohol consumption would make our analysis more accurate.

Another issue is that alcohol consumption per person takes into account the abstainers too, meaning that among drinking population values are higher.




# Gender Equality 

We investigated the relationship between happiness and gender equality. We, first, downloaded 2018 gender equality data from Kaggle. The dataset had different equality indicators, so we specifically selected “gender equality” for each country. We then joined gender equality and happiness datasets with population data from Gapminder to see if there is any correlation with world happiness.


For this section, we produced two plots. First one was a map that displayed the level of gender equality across the world. We used colour aesthetics to differentiate index of gender equality across countries. We, also, produced a bubble plot to show any relationship between gender equality and index of happiness in every continent. We interpreted data by mapping variables. We mapped size of population to the size of the country bubble and the countries were coloured based on the continent they are located.
Based on our results, gender equality is a significant factor when considering level of happiness in a country. Countries, with a considerably smaller population size and located in Europe, tend to have a high index of gender equality and happiness.


## Map 

```{r Gender Equality map}
earth <- ne_countries(scale = 50, returnclass = "sf") %>% 
  dplyr::select(admin, geometry, iso_a2)

equality <- left_join(earth, happy_data_2019, by = c("iso_a2" = "iso2c")) %>% 
  sf::st_as_sf() %>%
  filter(admin != "Antarctica")



equality %>%
  ggplot() +
  geom_sf(aes(fill = gender_equ_indicator), size = 0.1, color = "White") +
  coord_sf(crs = "+proj=longlat +ellps=WGS84")  + #Mollweide projection
scale_fill_gradient(low = "#DFF5EF", high = "#5DCEAF", na.value = "#DCDCDC")+ 
  labs(title = "Gender equality across the world", fill = "Gender equality index") + 
  theme_minimal() + 
   theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(), 
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_text(size=9, vjust = -1), 
        legend.title = element_text (size=9), 
        legend.position = "bottom")
  


```

## Bubble Plot 

```{r}

#happy_data_2019_02 <- happy_data_2019_02 #%>% 
 # select(country_or_region, region, score)

index_1 <- happy_data_2019 %>%
  filter(!is.na(region))
#View(index_1)
ggplot(index_1, aes(x=gender_equ_indicator,
                    y= score, fill = continent, size = population)) +
  geom_point(alpha = 0.5, shape = 21, color = "black") +
  geom_point(data = index_1 %>% filter(country_or_region == "United States"),
             aes(x=gender_equ_indicator, y = score,size = population),
             color = "red",shape = 21, stroke = 2, inherit.aes = FALSE) +
    xlab("Gender Equality Index") +
    ylab("Happiness Index") +
   # facet_wrap(~region) +
    labs(title = "More equal countries tend to be happier", subtitle = "Gender equality index vs. happiness score, \nby continent and population size", fill = "Continent") + 
  theme_minimal() +
  scale_size_continuous(breaks = c(5e+08, 1e+09), labels = c("500m", "1000m"), range = c(2, 22), name="Country Population Size")+ # Legend name + Size
  theme(legend.position = "right", legend.title = element_text(face = "bold", size = 9),
  legend.text = element_text(size = 8)) + # Legend position
    scale_fill_manual(values = c("#4E67C8", "#B4DCFA", "#FDB519", "#5DCEAF", "#F14124")) +# Color palette with legends shown
    #scale_fill_discrete(name = "Continent", labels = c("Europe", "Oceania", "Americas", "Asia", "Africa")) + 
    theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1))+
    guides(fill = guide_legend(override.aes = list(size = 4, colour = NA, alpha = 0.5))) +
    guides(size = guide_legend(override.aes = list(colour = "grey", stroke = 0.5))) +
    geom_curve(
      data = data.frame(x = 0.36, y = 7.5, xend = 0.6880262*0.95, yend = 6.985*1),
      mapping = aes(x = x, y = y, xend = xend, yend = yend),
      colour = "grey15",
      size = 0.5,
      curvature = -0.25,
      arrow = arrow(length = unit(2, "mm"), type = "closed"),
      inherit.aes = FALSE ) +
  # adding text field
    geom_text(
      data = data.frame(x = 0.3, y = 7.5, label = "United \nStates"),
      aes(x = x, y = y, label = label),
      #colour="#FDB519",
      family="Lato",
      #hjust = 1,
      vjust = 1,
      lineheight = .8,
      inherit.aes = FALSE,
      ) +  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
          plot.caption = element_text(size=7, color="gray"),
          plot.subtitle = element_text(size=9),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "gray"), 
          axis.text.x = element_text(size=7),
          axis.title = element_text(size=9, vjust = -1),
          #legend.position = "none"
          ) +
  NULL
```

In Gender equality dataset, a few countries, such as Iceland, Luxembourg, Malta, Kosovo, Montenegro, Bhutan, Laos, Palestinian Territories, Congo Kinshasa, and Comoros  were missing. Therefore, they were not shown in Gender Equality map. Also, when Happiness and Gender Equality dataset were joined, some countries had NA value for happiness or gender equality index. These countries had to be removed. It is also worth noting, that Gender Equality dataset was from 2018 year, while Happiness file was from 2019.



# ML model 

After we gathered common wisdom, myths and saysing across the world, it time to come back and put our knowledge to the test.
Lets see how well our 4 sayings can predict how happy a country is.

We build a prediction tree model that will include information on:

1) Wealth: Gini-index and Gdp per capita (in k)
2) Food: Food supply in kcal per capita per day
3) Alcohol: Litres of pure alcohol consumed per capita
4) Gender Equality: Gender equlaity index

We will use those 5 indicators to predict our independent variable, the happiness score.

First we split our data randomly into training and testing set. 
We then run a basic decision tree model.
We set minsplit = 10, so that each final node will at least hold 10 observations when attempting a split.

```{r}
# Fitting Decision Tree Regression to the dataset

#setting seed
set.seed(1)
dataset <- happy_data_2019 %>% 
  #mutating gdp to enhance readability
  mutate(gdpPercap_k = gdpPercap / 1000) %>% 
  #keeping only columns we want our tree model to use
  dplyr::select(c(score, gini, gdpPercap_k, food_supply_kcal_capita_day, total_litres_of_pure_alcohol, gender_equ_indicator))
# splitting data in test and training
split = sample.split(dataset$score, SplitRatio = 0.7)
training_set = subset(dataset, split == TRUE)
test_set = subset(dataset, split == FALSE)
#training tree model
regressor_dt = rpart(formula = score ~ .,
                  data = training_set,
                  control = rpart.control(minsplit = 10))
# Predicting a new result with Decision Tree Regression
y_pred_dt = predict(regressor_dt, newdata = test_set)
# combining actual and prediction scores for later visualization
Pred_Actual_dt <- as.data.frame(cbind(Prediction = y_pred_dt, Actual = test_set$score))
# plotting rules
rpart.plot(regressor_dt, main = "Results of the Decision Tree Model", box.palette = c("#B4DCFA","#5ECCF3","#4E67C8"), tweak = 1.1, shadow.col = "gray",family = "Lato")



```

We find a set of rules for predicting happiness in countries using our 5 indicators.
To clarify, lets look at Great Britain:

gdpPercap = 48700
gini = 33.2
total_litres_of_pure_alcohol = 10.4
food_supply_kcal_capita_day = 2656
gender_equ_indicator = 0.7780754

Following the path, we would make a prediction for a happiness score of 7.1

Knowing that, lets see how we did.

We are plotting our predictions made on the testing data set against their actual values to observe out-of-sample performance.


```{r}
# picking a country to highlight in later plots
# adding country data to testing set
x <- happy_data_2019[row.names(Pred_Actual_dt),]
# choosing GB as example
Pred_Actual_dt <- Pred_Actual_dt %>% 
  mutate(format = x$country_or_region == "United Kingdom")
#setting label to be siplayed in plot
label = "Despite limited prediction \npower for most countries,\n Brits seem to follow \nour tree rules!"
# plotting reuslts
ggplot(Pred_Actual_dt, aes(Actual, Prediction)) +
  geom_point(color = "#B4DCFA", size = 2)  +
  theme_minimal() + 
  geom_abline() +
  labs(title = "Actual Happiness diverts from our predictions, \nindicating bad model performance", subtitle= "Model predicitions vs. actual happiness score",x = "Actual happiness score",
       y = "Predicted happiness score") +
  scale_color_manual(values = c("#B4DCFA", "#FDB519")) +
  geom_curve(
    data = data.frame(x = 7.1, y = 5.5, xend = 7.1, yend = 7.029143),
    mapping = aes(x = x, y = y, xend = xend, yend = yend),
    colour = "grey15",
    size = 0.5,
    curvature = 0.25,
    arrow = arrow(length = unit(2, "mm"), type = "closed"),
    inherit.aes = FALSE ) +
  # adding text field
  geom_text(
    data = data.frame(x = 7.1, y = 5, label = label),
    aes(x = x, y = y, label = label),
    #colour="black",
    family="Lato",
    hjust = 0.5,
    lineheight = .8,
    inherit.aes = FALSE,
    ) +  
  theme(plot.title = element_text(face = "bold", size=12, family="Lato"),
        plot.caption = element_text(size=7, color="gray"),
        plot.subtitle = element_text(size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"), 
        axis.text.x = element_text(size=7),
        axis.title = element_text(size=9, vjust = -1),
        legend.position = "none") + 
  geom_point(data=Pred_Actual_dt %>% filter(format==TRUE),
             aes(x=Actual, y=Prediction), color = "red",shape = 21, stroke = 2, size = 5)
  
  
```


We can see that our model does not perfom outstanding well.
While our model does predict rough tendencies, many countries diverge from the black diagonal line (perfect prediction line).
However, for our example of Great Britain, our prediction seems to be spot on!

Like we mentioned above briefly, our prediction model should be taken with a grain of salt.
After all, model performance might suffer because of

- Insufficient amount of data points
- Strong correlation among the explanatory variables
- The fact that common proverbs do not seem to be the best starting point for prediction models

